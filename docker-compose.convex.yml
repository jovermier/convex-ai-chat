# Self-hosted Convex configuration using Docker Compose
# Based on: https://github.com/get-convex/convex-backend/blob/main/self-hosted/docker/docker-compose.yml
#
# For Coder workspace deployment, the setup script (scripts/setup-convex.sh) will
# automatically generate and configure the correct URLs based on your workspace.
# Format: https://<service>--<workspace>--<owner>.<coder-domain>
# Example: https://convex-api--my-workspace--myuser.coder.hahomelabs.com
services:
  convex-backend:
    image: ghcr.io/get-convex/convex-backend:latest
    container_name: convex-backend-local
    env_file:
      - .env.convex.local
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "3210:3210" # Convex API port
      - "3211:3211" # Convex site proxy port
    volumes:
      - convex-data:/convex/data
      - ./docker-entrypoint.sh:/docker-entrypoint.sh:ro
      - ./jwt_private_key.pem:/jwt_private_key.pem:ro
    entrypoint: ["/docker-entrypoint.sh"]
    environment:
      # Convex Cloud Origin - External URL for Convex API access
      # Automatically set by setup script in Coder workspaces
      # For local development, defaults to http://localhost:3210
      - CONVEX_CLOUD_ORIGIN=${CONVEX_CLOUD_ORIGIN:-http://localhost:3210}
      # Convex Site Origin - HTTP actions endpoint
      - CONVEX_SITE_ORIGIN=${CONVEX_SITE_ORIGIN:-http://localhost:3211}
      # PostgreSQL Database URL (required)
      - POSTGRES_URL=${POSTGRES_URL}
      # Instance name for identification (matches PostgreSQL database name)
      - INSTANCE_NAME=app
      # Admin key for authentication (generated on first start)
      - CONVEX_ADMIN_KEY=${CONVEX_ADMIN_KEY:-}
      # Logging
      - RUST_LOG=info,convex=debug
      # Lower document retention for development
      - DOCUMENT_RETENTION_DELAY=172800
      # Disable SSL requirement for local development
      - DO_NOT_REQUIRE_SSL=true
      # Auth configuration for @convex-dev/auth
      # Note: JWT_PRIVATE_KEY is set by docker-entrypoint.sh from JWT_PRIVATE_KEY_BASE64
      - JWT_ISSUER=${JWT_ISSUER:-http://localhost:3210}
      - CONVEX_SITE_URL=${CONVEX_SITE_URL:-http://localhost:3210}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3210/version"]
      interval: 5s
      start_period: 10s
      timeout: 5s
      retries: 3

  convex-dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    container_name: convex-dashboard-local
    env_file:
      - .env.convex.local
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "6791:6791" # Dashboard port
    environment:
      # Deployment URL for dashboard
      - NEXT_PUBLIC_DEPLOYMENT_URL=${CONVEX_DEPLOYMENT_URL:-http://localhost:3210}
    depends_on:
      convex-backend:
        condition: service_healthy

volumes:
  convex-data:
    driver: local
