# Function Deployment - Self-Hosted Convex Research

## Research Overview

This document compiles research findings about function deployment issues in self-hosted Convex deployments.

**Sources:**

- [Self-Hosted Convex README](https://github.com/get-convex/convex-backend/blob/main/self-hosted/README.md)
- [GitHub Issue #200](https://github.com/get-convex/convex-backend/issues/200)
- [GitHub Issue #61 (convex-js)](https://github.com/get-convex/convex-js/issues/61)
- [Convex CLI Documentation](https://docs.convex.dev/cli)

---

## Question 8: Why does `npx convex dev` fail with "BadAdminKey" even with the correct admin key?

### Answer

This is one of the most common issues with self-hosted Convex. The error occurs due to several potential causes:

### Root Causes

#### 1. **Admin Key Format Mismatch**

The admin key must be in the exact format generated by `generate_admin_key.sh`:

```bash
# Correct format
CONVEX_SELF_HOSTED_ADMIN_KEY='convex-self-hosted|016aecfef07a512ed12e84a21075e2d1c73ed88476c2ea5f55d7fb41899309686fafb88706'

# Incorrect formats (will fail):
CONVEX_SELF_HOSTED_ADMIN_KEY='016aecfef07a512ed12e84a21075e2d1c73ed88476c2ea5f55d7fb41899309686fafb88706'  # Missing instance name
CONVEX_SELF_HOSTED_ADMIN_KEY='convex self hosted|016aecfef...'  # Spaces instead of hyphens
```

#### 2. **Wrong Environment Variable**

Self-hosted Convex requires `CONVEX_SELF_HOSTED_ADMIN_KEY`, NOT `CONVEX_DEPLOY_KEY`:

```bash
# Correct for self-hosted
CONVEX_SELF_HOSTED_ADMIN_KEY='convex-self-hosted|<key>'

# Wrong (this is for cloud-hosted)
CONVEX_DEPLOY_KEY='<cloud-key>'
```

#### 3. **Instance Secret Mismatch**

If the container was recreated without volume persistence, the instance secret changed, invalidating old admin keys:

```bash
# Check if volume is mounted
docker volume ls
# Look for: <project>_data

# Regenerate admin key after container restart
docker compose exec backend ./generate_admin_key.sh
```

#### 4. **CLI Using Cloud Configuration**

The CLI may be trying to connect to Convex cloud instead of your self-hosted instance:

```bash
# Explicitly specify self-hosted URL
npx convex dev --url http://127.0.0.1:3210 --admin-key <your-key>

# Or set in .env.local
CONVEX_SELF_HOSTED_URL='http://127.0.0.1:3210'
CONVEX_SELF_HOSTED_ADMIN_KEY='convex-self-hosted|<key>'
```

### Solution Workflow

```bash
# 1. Start backend
docker compose up -d

# 2. Generate fresh admin key
docker compose exec backend ./generate_admin_key.sh
# Output: convex-self-hosted|<key>

# 3. Update .env.local
cat > .env.local << EOF
CONVEX_SELF_HOSTED_URL='http://127.0.0.1:3210'
CONVEX_SELF_HOSTED_ADMIN_KEY='convex-self-hosted|<exact-key-from-step-2>'
EOF

# 4. Run dev command
npx convex dev
```

---

## Question 9: How does the Convex CLI validate admin keys with the backend?

### Answer

The CLI validates admin keys through a specific API handshake process:

### Validation Flow

#### Step 1: Initial Connection

```bash
npx convex dev
```

The CLI reads configuration from `.env.local`:

- `CONVEX_SELF_HOSTED_URL` - Backend URL
- `CONVEX_SELF_HOSTED_ADMIN_KEY` - Admin key for authentication

#### Step 2: Admin Key Validation

The CLI makes a request to validate the admin key:

```bash
POST http://127.0.0.1:3210/api/check_admin_key
Authorization: Convex convex-self-hosted|<signature>
```

#### Step 3: Backend Verification

The backend:

1. Extracts instance name from admin key: `convex-self-hosted`
2. Retrieves instance secret from database
3. Validates the signature cryptographically
4. Returns success or `BadAdminKey` error

#### Step 4: Function Deployment

If validation succeeds, the CLI:

1. Bundles your Convex functions
2. Uploads them to the backend
3. Backend deploys functions to the runtime

### Error Responses

#### Success Response

```json
{
  "valid": true
}
```

#### BadAdminKey Error

```json
{
  "code": "BadAdminKey",
  "message": "The provided admin key was invalid for this instance"
}
```

### Debugging Validation Issues

```bash
# Test admin key manually
curl 'http://127.0.0.1:3210/api/check_admin_key' \
  -H 'Authorization: Convex convex-self-hosted|<key>' \
  -H 'Content-Type: application/json'

# Expected: {"valid": true}

# Enable debug logging in CLI
CONVEX_ENABLE_DEBUG_LOGS=true npx convex dev
```

---

## Question 10: What's the correct workflow for deploying functions to self-hosted Convex?

### Answer

The workflow differs slightly between development and production deployments.

### Development Workflow

#### 1. Start Backend

```bash
docker compose up -d
```

#### 2. Configure Environment

```bash
# .env.local (never commit)
CONVEX_SELF_HOSTED_URL='http://127.0.0.1:3210'
CONVEX_SELF_HOSTED_ADMIN_KEY='convex-self-hosted|<key>'
```

#### 3. Deploy Functions

```bash
# Development mode with hot reload
npx convex dev

# Or one-time deployment
npx convex deploy
```

### Production Workflow

#### 1. Deploy Backend to Infrastructure

```bash
# Using Docker on your server
docker compose -f docker-compose.prod.yml up -d
```

#### 2. Configure Production Environment

```bash
# In your CI/CD or production environment
CONVEX_SELF_HOSTED_URL='https://api.your-domain.com'
CONVEX_SELF_HOSTED_ADMIN_KEY='convex-self-hosted|<prod-key>'
```

#### 3. Deploy Functions

```bash
# In CI/CD pipeline
npx convex deploy --url https://api.your-domain.com --admin-key $CONVEX_SELF_HOSTED_ADMIN_KEY
```

### CI/CD Example (GitHub Actions)

```yaml
name: Deploy Convex Functions

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Deploy Convex functions
        env:
          CONVEX_SELF_HOSTED_URL: ${{ secrets.CONVEX_SELF_HOSTED_URL }}
          CONVEX_SELF_HOSTED_ADMIN_KEY: ${{ secrets.CONVEX_SELF_HOSTED_ADMIN_KEY }}
        run: npx convex deploy
```

### Vercel Deployment

```bash
# Install Convex CLI
npm install convex

# Set environment variables in Vercel dashboard
# CONVEX_SELF_HOSTED_URL
# CONVEX_SELF_HOSTED_ADMIN_KEY

# Deploy functions in build step
vercel build --command="npx convex deploy && npm run build"
```

---

## Question 11: Does self-hosted Convex require authentication with Convex cloud?

### Answer

**No** - self-hosted Convex is completely independent and does not require authentication with Convex cloud.

### Key Differences

#### Self-Hosted Convex

- ✅ No account required
- ✅ No authentication with Convex cloud
- ✅ No network calls to Convex infrastructure
- ✅ Complete data sovereignty
- ✅ Works offline (after initial setup)

#### Cloud-Hosted Convex

- Requires Convex account
- Authentication via email/password or OAuth
- Functions deployed to Convex infrastructure
- Data stored in Convex cloud

### Beacon (Anonymous Telemetry)

Self-hosted Convex includes a **beacon** that sends minimal anonymous data to Convex:

- Random deployment identifier
- Migration version
- Git revision
- Backend uptime

**To disable the beacon:**

```yaml
# docker-compose.yml
services:
  backend:
    environment:
      - DISABLE_BEACON=true
```

Or when running binary directly:

```bash
./convex-local-backend --disable-beacon
```

### Verification

```bash
# Check network connections
docker compose exec backend netstat -tulpn

# Should only see connections to:
# - Your database (PostgreSQL/MySQL)
# - Your frontend/dashboard
# - No connections to convex.dev or api.convex.dev
```

---

## Question 12: Can functions be deployed without the CLI (e.g., via API or file sync)?

### Answer

**Currently, the CLI is required** for function deployment. There is no direct API or file sync method for deploying functions to self-hosted Convex.

### Why CLI is Required

#### 1. **Function Bundling**

The CLI performs complex bundling operations:

- Transpiles TypeScript
- Bundles dependencies
- Optimizes code size
- Generates deployment metadata

#### 2. **Schema Validation**

The CLI validates:

- Schema definitions
- Index configurations
- Function signatures
- Type safety

#### 3. **Migration Management**

The CLI handles:

- Schema migrations
- Index creation/deletion
- Data consistency checks

### Workaround: Programmatic Deployment

You can script the CLI for automated deployments:

#### Option 1: Shell Script

```bash
#!/bin/bash
# deploy.sh

set -e

CONVEX_URL="${CONVEX_SELF_HOSTED_URL:-http://127.0.0.1:3210}"
ADMIN_KEY="${CONVEX_SELF_HOSTED_ADMIN_KEY}"

npx convex deploy \
  --url "$CONVEX_URL" \
  --admin-key "$ADMIN_KEY" \
  --dry-run \
  && echo "Deployment successful"
```

#### Option 2: Node.js Script

```javascript
// deploy.js
const { execSync } = require("child_process");

const deploy = async () => {
  try {
    const output = execSync("npx convex deploy", {
      env: {
        ...process.env,
        CONVEX_SELF_HOSTED_URL: process.env.CONVEX_SELF_HOSTED_URL,
        CONVEX_SELF_HOSTED_ADMIN_KEY: process.env.CONVEX_SELF_HOSTED_ADMIN_KEY,
      },
      encoding: "utf-8",
    });
    console.log(output);
  } catch (error) {
    console.error("Deployment failed:", error);
    process.exit(1);
  }
};

deploy();
```

#### Option 3: Docker Deployment Container

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .

ENV CONVEX_SELF_HOSTED_URL=http://backend:3210
ENV CONVEX_SELF_HOSTED_ADMIN_KEY=

CMD ["sh", "-c", "npx convex deploy && sleep infinity"]
```

### Future API Support

As of the research date (January 2026), there is no official deployment API. Monitor:

- [Convex GitHub Issues](https://github.com/get-convex/convex-backend/issues)
- [Convex Documentation](https://docs.convex.dev/self-hosting)

---

## Question 13: What's the purpose of `generate_admin_key.sh` and when should it be used?

### Answer

`generate_admin_key.sh` is a convenience script that generates admin keys for your self-hosted Convex instance.

### What It Does

The script:

1. Reads the instance secret from the database
2. Calls the `keybroker` binary to generate a cryptographically signed admin key
3. Outputs the admin key in the correct format

### When to Use It

#### 1. **Initial Setup**

```bash
docker compose up -d
docker compose exec backend ./generate_admin_key.sh
```

#### 2. **After Container Recreation**

```bash
# If you recreate the container (but keep the volume)
docker compose down
docker compose up -d

# Regenerate admin key
docker compose exec backend ./generate_admin_key.sh
```

#### 3. **Key Rotation**

```bash
# Generate new admin key
docker compose exec backend ./generate_admin_key.sh > new_admin_key.txt

# Update all references
# - .env.local
# - CI/CD secrets
# - Dashboard authentication
```

#### 4. **Multiple Environments**

```bash
# Development key
docker compose -f docker-compose.dev.yml exec backend ./generate_admin_key.sh > dev_key.txt

# Production key
docker compose -f docker-compose.prod.yml exec backend ./generate_admin_key.sh > prod_key.txt
```

### What It Does NOT Do

- ❌ Does NOT change the instance secret
- ❌ Does NOT invalidate existing admin keys
- ❌ Does NOT require container restart
- ❌ Does NOT affect deployed functions

### Manual Equivalent

If the script is not available, you can generate admin keys manually:

```bash
# Get instance secret (stored in database)
# This is complex and not recommended - use the script instead

# Or use the keybroker directly if you have the instance secret
cargo run -p keybroker --bin generate_key -- convex-self-hosted <instance-secret>
```

### Best Practices

#### 1. Store Generated Keys Securely

```bash
# Generate and save to secure storage
docker compose exec backend ./generate_admin_key.sh | pass insert -m convex/admin-key

# Or save to password manager
docker compose exec backend ./generate_admin_key.sh | bwget password
```

#### 2. Document Key Usage

```bash
# Generate with metadata
echo "$(docker compose exec backend ./generate_admin_key.sh) # Generated: $(date)" >> admin_keys.log
```

#### 3. Rotate Regularly

```bash
# Set up cron job for monthly rotation
0 0 1 * * docker compose exec backend ./generate_admin_key.sh | mail -s "New Convex Admin Key" admin@example.com
```

---

## Question 14: How does the `/app/convex` mount affect function loading?

### Answer

The `/app/convex` mount is used for **local development mode** where functions are loaded directly from the host machine, enabling hot reload.

### Mount Configurations

#### Development Mode (Hot Reload)

```yaml
# docker-compose.dev.yml
services:
  backend:
    volumes:
      - ./convex:/app/convex:ro # Mount local convex directory
    environment:
      - CONVEX_DEV_MODE=true
```

**Effects:**

- Functions loaded directly from host
- Changes reflected immediately
- No deployment required
- Faster development iteration

#### Production Mode (No Mount)

```yaml
# docker-compose.prod.yml
services:
  backend:
    volumes:
      - data:/convex/data # Only data volume, no function mount
```

**Effects:**

- Functions deployed via CLI
- Changes require redeployment
- More stable and predictable
- Suitable for production

### How It Works

#### Development Flow

```bash
# 1. Mount local convex directory
docker compose -f docker-compose.dev.yml up -d

# 2. Edit function locally
vim convex/messages.ts

# 3. Changes automatically loaded
# No deployment needed!

# 4. Test immediately
curl http://127.0.0.1:3210/api/messages
```

#### Production Flow

```bash
# 1. No mount
docker compose -f docker-compose.prod.yml up -d

# 2. Deploy functions via CLI
npx convex deploy

# 3. Changes require redeployment
vim convex/messages.ts
npx convex deploy

# 4. Test after deployment
curl http://127.0.0.1:3210/api/messages
```

### Caveats

#### 1. **Read-Only Mount**

```yaml
volumes:
  - ./convex:/app/convex:ro # :ro prevents container from writing
```

Always use read-only mounts to prevent the container from modifying your source code.

#### 2. **Permission Issues**

If you encounter permission errors:

```yaml
services:
  backend:
    user: "${UID}:${GID}" # Match host user permissions
    volumes:
      - ./convex:/app/convex:ro
```

#### 3. **File Watching**

The backend watches for file changes in development mode:

```bash
# Check if file watching is working
docker compose logs backend | grep "Watching for file changes"
```

#### 4. **TypeScript Compilation**

Functions are compiled on-the-fly in development mode. Ensure TypeScript is installed:

```bash
# In your project
npm install -D typescript
```

### Hybrid Approach

You can use both modes simultaneously:

```yaml
# docker-compose.yml
services:
  backend-dev:
    volumes:
      - ./convex:/app/convex:ro
    environment:
      - CONVEX_DEV_MODE=true
    ports:
      - "3210:3210"

  backend-prod:
    volumes:
      - data:/convex/data
    ports:
      - "3211:3210"
```

Use `backend-dev` for development and `backend-prod` for testing production deployments.

---

## Common Issues and Solutions

### Issue: "Could not find public function"

**From GitHub Issue #200**

**Symptoms:**

```bash
npx convex dev
# Error: Could not find public function
```

**Root Causes:**

1. Functions not deployed
2. Incorrect function path
3. Schema not synced

**Solutions:**

```bash
# 1. Deploy functions
npx convex deploy

# 2. Check function exists
ls convex/messages.ts

# 3. Verify schema
npx convex dashboard
```

### Issue: CLI Asks for CONVEX_DEPLOY_KEY in Self-Hosted Mode

**From GitHub Issue #61**

**Symptoms:**

```bash
npx convex deploy
# Error: CONVEX_DEPLOY_KEY is required
```

**Root Cause:**
CLI checks for cloud deployment variables before self-hosted variables.

**Solution:**

```bash
# Explicitly specify self-hosted
npx convex deploy \
  --url $CONVEX_SELF_HOSTED_URL \
  --admin-key $CONVEX_SELF_HOSTED_ADMIN_KEY

# Or use .env.local
cat > .env.local << EOF
CONVEX_SELF_HOSTED_URL='http://127.0.0.1:3210'
CONVEX_SELF_HOSTED_ADMIN_KEY='convex-self-hosted|<key>'
EOF
```

### Issue: Functions Not Updating After Deployment

**Symptoms:**

```bash
npx convex deploy
# Function returns old results
```

**Solutions:**

```bash
# 1. Clear cache
npx convex deploy --no-cache

# 2. Check deployment status
npx convex deployment status

# 3. Restart backend
docker compose restart backend
```

---

## Best Practices

### 1. Development Workflow

```bash
# Use hot reload for development
docker compose -f docker-compose.dev.yml up -d

# Edit files locally
vim convex/functions.ts

# Test immediately
npx convex run
```

### 2. Production Deployment

```bash
# Deploy to staging first
npx convex deploy --url https://staging.api.example.com --admin-key $STAGING_KEY

# Test staging
# ... run tests ...

# Deploy to production
npx convex deploy --url https://api.example.com --admin-key $PROD_KEY
```

### 3. CI/CD Integration

```yaml
# .github/workflows/deploy.yml
- name: Deploy Convex functions
  run: |
    npx convex deploy \
      --url ${{ secrets.CONVEX_SELF_HOSTED_URL }} \
      --admin-key ${{ secrets.CONVEX_SELF_HOSTED_ADMIN_KEY }} \
      --dry-run
```

### 4. Environment Management

```bash
# .env.local (development)
CONVEX_SELF_HOSTED_URL='http://127.0.0.1:3210'
CONVEX_SELF_HOSTED_ADMIN_KEY='dev-key'

# .env.production (production)
CONVEX_SELF_HOSTED_URL='https://api.example.com'
CONVEX_SELF_HOSTED_ADMIN_KEY='prod-key'
```

---

## Summary

| Question                                                 | Key Finding                                                |
| -------------------------------------------------------- | ---------------------------------------------------------- |
| **Q8: Why does `npx convex dev` fail with BadAdminKey?** | Instance secret changed, wrong env var, or format mismatch |
| **Q9: How does CLI validate admin keys?**                | Cryptographic signature validation via API endpoint        |
| **Q10: Correct deployment workflow?**                    | Generate key → Configure .env.local → Deploy with CLI      |
| **Q11: Requires cloud authentication?**                  | No - completely independent (except optional beacon)       |
| **Q12: Deploy without CLI?**                             | No - CLI required for bundling, validation, migrations     |
| **Q13: Purpose of generate_admin_key.sh?**               | Generate signed admin keys from instance secret            |
| **Q14: How does /app/convex mount work?**                | Enables hot reload in development mode                     |

---

## References

- [Self-Hosted Convex Guide](https://github.com/get-convex/convex-backend/blob/main/self-hosted/README.md)
- [GitHub Issue #200: Error when running npx convex dev](https://github.com/get-convex/convex-backend/issues/200)
- [GitHub Issue #61: Vercel deployment error](https://github.com/get-convex/convex-js/issues/61)
- [Convex CLI Documentation](https://docs.convex.dev/cli)
- [Docker Compose Configuration](https://github.com/get-convex/convex-backend/blob/main/self-hosted/docker/docker-compose.yml)

---

**Last Updated:** January 16, 2026
**Research Date:** January 16, 2026
**Convex Backend Version:** Latest (as of research date)
